#include <common.h>
#include <asm/io.h>
#include <asm/armv7.h>

/************************************************************
 * Boot m0 and m0 goes int WFI state
 ************************************************************
 */
 
#define dsb()	CP15DSB


#if CONFIG_WATCHDOG_ENABLE

#define TAG_DATA_OFFSET		(M0_RAM_BASE + 0x10004)
#define TAG_DATA_COMPLETE	(0xaaaaaaaa)

#if CONFIG_WATCHDOG_DEBUG

static unsigned short m0_bin_code[] = {
	0x0C98, 0x0000, 0x013D, 0x0000, 0x0145, 0x0000, 0x0147, 0x0000, 0x0149, 0x0000, 0x014B, 0x0000, 0x014D, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x014F, 0x0000, 0x0151, 0x0000, 0x0000, 0x0000, 0x0153, 0x0000, 0x0155, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0511, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0xF000, 0xF802, 0xF000, 0xF832,
	0xA00C, 0xC830, 0x3808, 0x1824, 0x182D, 0x46A2, 0x1E67, 0x46AB, 0x4654, 0x465D, 0x42AC, 0xD101, 0xF000, 0xF824, 0x467E, 0x3E0F,
	0xCC0F, 0x46B6, 0x2601, 0x4233, 0xD000, 0x1AFB, 0x46A2, 0x46AB, 0x4333, 0x4718, 0x0748, 0x0000, 0x0758, 0x0000, 0x2300, 0x2400,
	0x2500, 0x2600, 0x3A10, 0xD301, 0xC178, 0xD8FB, 0x0752, 0xD300, 0xC130, 0xD500, 0x600B, 0x4770, 0xB51F, 0x46C0, 0x46C0, 0xBD1F,
	0xB510, 0xBD10, 0xF000, 0xFB58, 0x4611, 0xF7FF, 0xFFF5, 0xF000, 0xFA8D, 0xF000, 0xFB70, 0xB403, 0xF7FF, 0xFFF2, 0xBC03, 0xF000,
	0xFB75, 0x0000, 0x4803, 0x4904, 0x6008, 0x4770, 0x4801, 0x4902, 0x6008, 0x4770, 0x6C00, 0x02DC, 0x082C, 0x0000, 0x480A, 0x4780,
	0x480A, 0x4700, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0x4805, 0x4906, 0x4A04, 0x4B06,
	0x4770, 0x0000, 0xBF30, 0x4770, 0x012D, 0x0000, 0x0099, 0x0000, 0x0898, 0x0000, 0x0C98, 0x0000, 0x0898, 0x0000, 0x2100, 0xBF00,
	0x7802, 0x2A00, 0xD00B, 0xBF00, 0x4AB5, 0x6952, 0x2320, 0x401A, 0x2A20, 0xD1F9, 0x7802, 0x4BB2, 0x601A, 0x1C40, 0xE000, 0x2101,
	0x2900, 0xD0ED, 0x4770, 0x4601, 0x2001, 0x2200, 0xE002, 0x230A, 0x4358, 0x1C52, 0x428A, 0xD3FA, 0x4770, 0xB5F3, 0xB085, 0x4604,
	0x2000, 0x9004, 0xBF00, 0x7820, 0x2800, 0xD00E, 0x7820, 0x2825, 0xD00B, 0xBF00, 0x48A2, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9,
	0x7820, 0x499F, 0x6008, 0x1C64, 0xE082, 0x7820, 0x2825, 0xD17D, 0x2000, 0x9001, 0x1C64, 0x7820, 0x2864, 0xD002, 0x7820, 0x2844,
	0xD135, 0x9F06, 0x2609, 0xE022, 0x4630, 0xF7FF, 0xFFCC, 0x9002, 0x4638, 0x9902, 0xF000, 0xFA20, 0x4605, 0x2D00, 0xD001, 0x2001,
	0x9001, 0x9801, 0x2800, 0xD010, 0x4628, 0x3030, 0xB2C0, 0x9003, 0x9802, 0x4368, 0x1A3F, 0xBF00, 0x4889, 0x6940, 0x2120, 0x4008,
	0x2820, 0xD1F9, 0x4986, 0x9803, 0x6008, 0x1E70, 0xB2C6, 0x2E00, 0xDCDA, 0x4638, 0x3030, 0xB2C0, 0x9003, 0xBF00, 0x4880, 0x6940,
	0x2120, 0x4008, 0x2820, 0xD1F9, 0x497D, 0x9803, 0x6008, 0x7820, 0x2878, 0xD002, 0x7820, 0x2858, 0xD135, 0x9F06, 0x2608, 0xE023,
	0x1E70, 0x0081, 0x4638, 0x40C8, 0x0705, 0x0F2D, 0x2D00, 0xD001, 0x2001, 0x9001, 0x9801, 0x2800, 0xD014, 0x2D09, 0xD904, 0x4628,
	0x3037, 0xB2C0, 0x9003, 0xE003, 0x4628, 0x3030, 0xB2C0, 0x9003, 0xBF00, 0x486B, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9, 0x4968,
	0x9803, 0x6008, 0x1E70, 0xB2C6, 0x2E00, 0xDCD9, 0x9801, 0x2800, 0xD109, 0xBF00, 0x4862, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9,
	0x2030, 0x495F, 0x6008, 0x1C64, 0xE002, 0xE7FF, 0x2001, 0x9004, 0x9804, 0x2800, 0xD100, 0xE766, 0xB007, 0xBDF0, 0xB5F7, 0xB086,
	0x4604, 0x2000, 0x9001, 0x9005, 0xBF00, 0x7820, 0x2800, 0xD00E, 0x7820, 0x2825, 0xD00B, 0xBF00, 0x4851, 0x6940, 0x2120, 0x4008,
	0x2820, 0xD1F9, 0x7820, 0x494E, 0x6008, 0x1C64, 0xE092, 0x7820, 0x2825, 0xD17E, 0x1C64, 0x7820, 0x2864, 0xD002, 0x7820, 0x2844,
	0xD13D, 0x2000, 0x9003, 0x9801, 0x2800, 0xD101, 0x9F07, 0xE000, 0x9F08, 0x2609, 0xE022, 0x4630, 0xF7FF, 0xFF25, 0x9002, 0x4638,
	0x9902, 0xF000, 0xF979, 0x4605, 0x2D00, 0xD001, 0x2001, 0x9003, 0x9803, 0x2800, 0xD010, 0x4628, 0x3030, 0xB2C0, 0x9004, 0x9802,
	0x4368, 0x1A3F, 0xBF00, 0x4836, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9, 0x4933, 0x9804, 0x6008, 0x1E70, 0xB2C6, 0x2E00, 0xDCDA,
	0x4638, 0x3030, 0xB2C0, 0x9004, 0xBF00, 0x482D, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9, 0x492A, 0x9804, 0x6008, 0xE044, 0x7820,
	0x2878, 0xD002, 0x7820, 0x2858, 0xD13E, 0x2000, 0x9003, 0x9801, 0x2800, 0xD101, 0x9F07, 0xE000, 0x9F08, 0x2608, 0xE023, 0x1E70,
	0x0081, 0x4638, 0x40C8, 0x0705, 0x0F2D, 0x2D00, 0xD001, 0x2001, 0x9003, 0x9803, 0x2800, 0xD014, 0x2D09, 0xD904, 0x4628, 0x3037,
	0xB2C0, 0x9004, 0xE003, 0x4628, 0x3030, 0xB2C0, 0x9004, 0xBF00, 0x4813, 0x6940, 0x2120, 0x4008, 0x2820, 0xD1F9, 0x4910, 0x9804,
	0x6008, 0x1E70, 0xB2C6, 0x2E00, 0xDCD9, 0x9803, 0x2800, 0xD10B, 0xE000, 0xE00D, 0xBF00, 0x480A, 0x6940, 0x2120, 0x4008, 0x2820,
	0xD1F9, 0x2030, 0x4906, 0x6008, 0x2001, 0x9001, 0x1C64, 0xE001, 0x2001, 0x9005, 0x9805, 0x2800, 0xD100, 0xE756, 0xB009, 0xBDF0,
	0x6000, 0xA100, 0x4601, 0x2930, 0xDB03, 0x2939, 0xDC01, 0x2001, 0x4770, 0x2941, 0xDB03, 0x2946, 0xDC01, 0x2002, 0xE7F8, 0x2961,
	0xDB03, 0x2966, 0xDC01, 0x2003, 0xE7F2, 0x2930, 0xDB03, 0x2939, 0xDC01, 0x2001, 0xE7EC, 0x2000, 0xE7EA, 0xB510, 0x2200, 0x2300,
	0x2404, 0xE02E, 0x4840, 0x6800, 0x1C40, 0x493F, 0x6008, 0xBF00, 0x483E, 0x6940, 0x07C0, 0x0FC0, 0xD0FA, 0x483C, 0x6800, 0xB2C2,
	0xBF00, 0x483A, 0x6940, 0x2140, 0x4208, 0xD0FA, 0x4837, 0x6002, 0x4610, 0xF7FF, 0xFFC7, 0x4604, 0x2C01, 0xD103, 0x4610, 0x3830,
	0xB2C2, 0xE00C, 0x2C02, 0xD103, 0x4610, 0x3837, 0xB2C2, 0xE006, 0x2C03, 0xD103, 0x4610, 0x3857, 0xB2C2, 0xE000, 0xE005, 0x011B,
	0x189B, 0x2A0D, 0xD1CE, 0x2A0A, 0xD1CC, 0xBF00, 0x4618, 0xBD10, 0xE048, 0xA027, 0xF7FF, 0xFE32, 0x2000, 0x4923, 0x6008, 0xF7FF,
	0xFFBC, 0x4605, 0x462C, 0x4820, 0x6800, 0x2801, 0xD93A, 0x07A0, 0x0F80, 0xD003, 0xA027, 0xF7FF, 0xFE21, 0xE033, 0x2005, 0x0740,
	0x4284, 0xD302, 0x4828, 0x4284, 0xD323, 0x4828, 0x4284, 0xD302, 0x4827, 0x4284, 0xD31D, 0xBF00, 0x2001, 0x0440, 0x4284, 0xD318,
	0x4824, 0x4284, 0xD302, 0x4824, 0x4284, 0xD312, 0x4823, 0x4284, 0xD302, 0x4823, 0x4284, 0xD30C, 0x4822, 0x4284, 0xD302, 0x4822,
	0x4284, 0xD306, 0x20A1, 0x0600, 0x4284, 0xD308, 0x481F, 0x4284, 0xD205, 0x4629, 0xA01E, 0x6822, 0xF7FF, 0xFEB0, 0xE002, 0xA00D,
	0xF7FF, 0xFDEC, 0xE7B5, 0x0000, 0x0830, 0x0000, 0x6000, 0xA100, 0x6C50, 0x6165, 0x6573, 0x6920, 0x706E, 0x7475, 0x7220, 0x6765,
	0x7369, 0x6574, 0x2072, 0x6461, 0x7264, 0x7365, 0x3A73, 0x0A0D, 0x0000, 0x0000, 0x6E49, 0x6176, 0x696C, 0x2064, 0x6461, 0x7264,
	0x7365, 0x0D73, 0x000A, 0x0000, 0x5000, 0xA000, 0x8000, 0xA000, 0x9800, 0xA000, 0x0000, 0xA006, 0x1000, 0xA006, 0x0000, 0xA020,
	0x0000, 0xA028, 0x8800, 0xA010, 0x0000, 0xA012, 0x7C00, 0xA100, 0x6461, 0x7264, 0x7365, 0x2073, 0x7825, 0x7620, 0x6C61, 0x6575,
	0x6920, 0x2073, 0x7825, 0x0A0D, 0x0000, 0x0000, 0x2401, 0x0424, 0x4807, 0xC401, 0x0040, 0x6020, 0xBF00, 0x200B, 0x2101, 0x4081,
	0x4804, 0x6001, 0xBF00, 0xF7FF, 0xFD8D, 0xBF00, 0xE7FE, 0x0000, 0x5555, 0x5555, 0xE100, 0xE000, 0x2200, 0x0903, 0x428B, 0xD32C,
	0x0A03, 0x428B, 0xD311, 0x2300, 0x469C, 0xE04E, 0x4603, 0x430B, 0xD43C, 0x2200, 0x0843, 0x428B, 0xD331, 0x0903, 0x428B, 0xD31C,
	0x0A03, 0x428B, 0xD301, 0x4694, 0xE03F, 0x09C3, 0x428B, 0xD301, 0x01CB, 0x1AC0, 0x4152, 0x0983, 0x428B, 0xD301, 0x018B, 0x1AC0,
	0x4152, 0x0943, 0x428B, 0xD301, 0x014B, 0x1AC0, 0x4152, 0x0903, 0x428B, 0xD301, 0x010B, 0x1AC0, 0x4152, 0x08C3, 0x428B, 0xD301,
	0x00CB, 0x1AC0, 0x4152, 0x0883, 0x428B, 0xD301, 0x008B, 0x1AC0, 0x4152, 0x0843, 0x428B, 0xD301, 0x004B, 0x1AC0, 0x4152, 0x1A41,
	0xD200, 0x4601, 0x4152, 0x4610, 0x4770, 0xE05D, 0x0FCA, 0xD000, 0x4249, 0x1003, 0xD300, 0x4240, 0x4053, 0x2200, 0x469C, 0x0903,
	0x428B, 0xD32D, 0x0A03, 0x428B, 0xD312, 0x22FC, 0x0189, 0xBA12, 0x0A03, 0x428B, 0xD30C, 0x0189, 0x1192, 0x428B, 0xD308, 0x0189,
	0x1192, 0x428B, 0xD304, 0x0189, 0xD03A, 0x1192, 0xE000, 0x0989, 0x09C3, 0x428B, 0xD301, 0x01CB, 0x1AC0, 0x4152, 0x0983, 0x428B,
	0xD301, 0x018B, 0x1AC0, 0x4152, 0x0943, 0x428B, 0xD301, 0x014B, 0x1AC0, 0x4152, 0x0903, 0x428B, 0xD301, 0x010B, 0x1AC0, 0x4152,
	0x08C3, 0x428B, 0xD301, 0x00CB, 0x1AC0, 0x4152, 0x0883, 0x428B, 0xD301, 0x008B, 0x1AC0, 0x4152, 0xD2D9, 0x0843, 0x428B, 0xD301,
	0x004B, 0x1AC0, 0x4152, 0x1A41, 0xD200, 0x4601, 0x4663, 0x4152, 0x105B, 0x4610, 0xD301, 0x4240, 0x2B00, 0xD500, 0x4249, 0x4770,
	0x4663, 0x105B, 0xD300, 0x4240, 0xB501, 0x2000, 0x46C0, 0x46C0, 0xBD02, 0x4770, 0x4770, 0x4770, 0x4675, 0xF000, 0xF823, 0x46AE,
	0x0005, 0x4669, 0x4653, 0x08C0, 0x00C0, 0x4685, 0xB018, 0xB520, 0xF7FF, 0xFCC2, 0xBC60, 0x2700, 0x0849, 0x46B6, 0x2600, 0xC5C0,
	0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0x3D40, 0x0049, 0x468D, 0x4770, 0x4604, 0x46C0, 0x46C0, 0x4620, 0xF7FF,
	0xFC8A, 0x0000, 0x4800, 0x4770, 0x0834, 0x0000, 0x4901, 0x2018, 0xBEAB, 0xE7FE, 0x0026, 0x0002, 0x4770, 0x0000, 0x0834, 0x0000,
	0x0834, 0x0000, 0x0464, 0x0000, 0x00DC, 0x0000, 0x6C00, 0x02DC, 0x0000, 0x0000,
};

#else /* CONFIG_WATCHDOG_DEBUG */

static unsigned short m0_bin_code[] = {
	0x06C0, 0x0000, 0x013D, 0x0000, 0x0145, 0x0000, 0x0147, 0x0000, 0x0149, 0x0000, 0x014B, 0x0000, 0x014D, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x014F, 0x0000, 0x0151, 0x0000, 0x0000, 0x0000, 0x0153, 0x0000, 0x0155, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x017D, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000,
	0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0x0157, 0x0000, 0xF000, 0xF802, 0xF000, 0xF832,
	0xA00C, 0xC830, 0x3808, 0x1824, 0x182D, 0x46A2, 0x1E67, 0x46AB, 0x4654, 0x465D, 0x42AC, 0xD101, 0xF000, 0xF824, 0x467E, 0x3E0F,
	0xCC0F, 0x46B6, 0x2601, 0x4233, 0xD000, 0x1AFB, 0x46A2, 0x46AB, 0x4333, 0x4718, 0x0174, 0x0000, 0x0184, 0x0000, 0x2300, 0x2400,
	0x2500, 0x2600, 0x3A10, 0xD301, 0xC178, 0xD8FB, 0x0752, 0xD300, 0xC130, 0xD500, 0x600B, 0x4770, 0xB51F, 0x46C0, 0x46C0, 0xBD1F,
	0xB510, 0xBD10, 0xF000, 0xF86F, 0x4611, 0xF7FF, 0xFFF5, 0xF000, 0xF849, 0xF000, 0xF887, 0xB403, 0xF7FF, 0xFFF2, 0xBC03, 0xF000,
	0xF88B, 0x0000, 0x4803, 0x4904, 0x6008, 0x4770, 0x4801, 0x4902, 0x6008, 0x4770, 0x6C00, 0x02DC, 0x0258, 0x0000, 0x480A, 0x4780,
	0x480A, 0x4700, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0xE7FE, 0x4805, 0x4906, 0x4A04, 0x4B06,
	0x4770, 0x0000, 0xBF30, 0x4770, 0x012D, 0x0000, 0x0099, 0x0000, 0x02C0, 0x0000, 0x06C0, 0x0000, 0x02C0, 0x0000, 0x2000, 0xE000,
	0x1C40, 0x4906, 0x4288, 0xD3FB, 0x4905, 0x6BC9, 0x2201, 0x0312, 0x4391, 0x4A03, 0x63D1, 0x21FF, 0x6011, 0x4770, 0xE360, 0x0016,
	0xA980, 0xA010, 0x480B, 0x490C, 0x6809, 0x6008, 0x480A, 0x6800, 0x1D00, 0x4909, 0x6008, 0x4807, 0x43C0, 0x6809, 0x6008, 0xBF00,
	0x200B, 0x2101, 0x4081, 0x4805, 0x6001, 0xBF00, 0xF7FF, 0xFFCA, 0xBF00, 0xE7FE, 0x5555, 0x5555, 0x025C, 0x0000, 0xE100, 0xE000,
	0x4770, 0x4770, 0x4770, 0x4675, 0xF000, 0xF822, 0x46AE, 0x0005, 0x4669, 0x4653, 0x08C0, 0x00C0, 0x4685, 0xB018, 0xB520, 0xF7FF,
	0xFFAB, 0xBC60, 0x2700, 0x0849, 0x46B6, 0x2600, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0xC5C0, 0x3D40, 0x0049,
	0x468D, 0x4770, 0x4604, 0x46C0, 0x46C0, 0x4620, 0xF7FF, 0xFF73, 0x4800, 0x4770, 0x0260, 0x0000, 0x4901, 0x2018, 0xBEAB, 0xE7FE,
	0x0026, 0x0002, 0x4770, 0x0000, 0x0260, 0x0000, 0x0260, 0x0000, 0x0460, 0x0000, 0x00DC, 0x0000, 0x6C00, 0x02DC, 0x0000, 0x0001,
};

#endif /* CONFIG_WATCHDOG_DEBUG */


#else /* CONFIG_WATCHDOG_ENABLE */

#define TAG_DATA_OFFSET		(M0_RAM_BASE + 8)
#define TAG_DATA_COMPLETE	(0xbabababa)

 /*	
  *00000000 <stext>:	 
  *  0: 00000080	;sp_main
  *  4: 0000000c+1	.word	0x0000000c ; reset address
  *
  *  00000008 <tag_init>:
  *  8: abababab	.word	0xabababab
  *	
  *0000000c <m0_stext>: 
  *  c: 4905		ldr	r1, [pc, #20]	(24 <_endless+0xe>)	
  *  e: 4806		ldr	r0, [pc, #24]	(28 <_endless+0x12>)
  *  10:	6809		ldr	r1, [r1, #0]
  *  12:	6001		str	r1, [r0, #0]
  *  14:	2000		movs	r0, #0
  *	
  *00000016 <_endless>:
  * 16: f3bf 8f4f	dsb	sy
  * 1a: bf30		wfi
  * 1c: f3bf 8f6f	isb	sy
  * 20: e7f9		b.n	16 <_endless>
  * 22: 46f7		mov	pc, lr
  * 24: 0000002c	.word	0x0000002c
  * 28: 00000008	.word	0x00000008
  *
  *0000002c <tag_complete>:	
  * 2c: babababa	.word	0xbabababa	
  * 30: ffffffff	.word	0xffffffff	
  */
  
static unsigned short m0_bin_code[] = {
	0x0080, 0x0000, 0x000d, 0x0000, 0xabab, 0xabab,
	0x4905, 0x4806, 0x6809, 0x6001, 0x2000, 0xf3bf,
	0x8f4f, 0xbf30, 0xf3bf, 0x8f6f, 0xe7f9, 0x46f7,
	0x002c, 0x0000, 0x0008, 0x0000, 0xbaba, 0xbaba,
	0xffff, 0xffff
};
#endif /* CONFIG_WATCHDOG_ENABLE */

static void m0_sysclk_on(void)
{
	unsigned int mask;
		
	mask = __raw_readl(AP_PWR_SYSCLK_EN0);
	if (!(mask & (1 << AP_PWR_SYSCLK_EN0_M0_CLK_EN))) {
		mask = 1 << AP_PWR_SYSCLK_EN0_M0_CLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_CLK_EN_WE;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_DCLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_DCLK_EN_WE;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_RAM_CLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_RAM_CLK_EN_WE;
		__raw_writel(mask, AP_PWR_SYSCLK_EN0);
		dsb();
	}
}

static void m0_sysclk_off(void)
{
	unsigned int mask;
		
	mask = __raw_readl(AP_PWR_SYSCLK_EN0);
	if (mask & (1 << AP_PWR_SYSCLK_EN0_M0_CLK_EN)) {
		mask = 0 << AP_PWR_SYSCLK_EN0_M0_CLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_CLK_EN_WE;
		mask |= 0 << AP_PWR_SYSCLK_EN0_M0_DCLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_DCLK_EN_WE;
		mask |= 0 << AP_PWR_SYSCLK_EN0_M0_RAM_CLK_EN;
		mask |= 1 << AP_PWR_SYSCLK_EN0_M0_RAM_CLK_EN_WE;
		__raw_writel(mask, AP_PWR_SYSCLK_EN0);
		dsb();
	}
}

static void m0_rst_release(void)
{
	unsigned int mask;
		
	mask = __raw_readl(AP_PWR_M0_RSTCTL);
	if (mask & (1 << AP_PWR_M0_HRST)) {
		mask = 0 << AP_PWR_M0_HRST | 
				1 << AP_PWR_M0_DBG_RST;
		__raw_writel(mask, AP_PWR_M0_RSTCTL);
		dsb();
	}
}

static void m0_rst_hold(void)
{
	unsigned int mask;
		
	mask = __raw_readl(AP_PWR_M0_RSTCTL);
	if (!(mask & (1 << AP_PWR_M0_HRST))) {
		mask = 1 << AP_PWR_M0_HRST | 
				1 << AP_PWR_M0_DBG_RST;
		__raw_writel(mask, AP_PWR_M0_RSTCTL);
		dsb();
	}
}

static void m0_startup(void)
{
	m0_sysclk_on();

	/*TODO: wait for a while ?*/
	
	m0_rst_release();
	
	/*TODO: wait for a while ?*/
}

static void m0_reset(void)
{
	m0_rst_hold();
	/*TODO: wait for a while ?*/
	
	m0_sysclk_on();
	/*TODO: wait for a while ?*/
	
	m0_rst_release();	
	/*TODO: wait for a while ?*/	
}

static int m0_ready(void)
{
	return (__raw_readl(TAG_DATA_OFFSET) == TAG_DATA_COMPLETE);
}

static void m0_wait(void)
{
	volatile unsigned long timeout = 10000;
	
	while (timeout > 0) {
		if (m0_ready())
			break;
		timeout -= 10;
		udelay(10);
	}
}

static void m0_code_update(void)
{
	int i;
	unsigned long addr = M0_RAM_BASE;

	for (i = 0; i < ARRAY_SIZE(m0_bin_code); ++i) {
		__raw_writew(m0_bin_code[i], addr);
		addr += 2;
	}
	dsb();
}

static void m0_regs_init(void)
{
	__raw_writel(0xffffffff, AP_PWR_M0INTIN_MK);
}

int m0_boot(void)
{
	int try_cnt = 3;
	int retval = -1;
#if CONFIG_WATCHDOG_ENABLE
	int watchdog_enable = 1;
#else
	int watchdog_enable = 0;
#endif

	m0_code_update();
	m0_startup();
	m0_wait();
	
	do {
		if (!m0_ready()) {
			m0_reset();
			m0_wait();	
		} else {
			retval = 0;
			break;
		}
	} while (try_cnt--);

	if (m0_ready())
		retval = 0;

	/*assure that M0 is in WFI*/
	if (!retval)
		udelay(10);

	if (!watchdog_enable)
		m0_sysclk_off();

	if (retval)
		printf("m0 boot fail\n");

	m0_regs_init();

	return retval; 
}


